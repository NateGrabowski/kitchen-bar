<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen Bar 3D Planner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a1628;
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
    }
    #canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
      // Fixed architectural constraint
      stepHeight: 23.5,

      // Bar dimensions (inches)
      barTopHeight: 40,
      barDepth: 28,
      cabinetDepth: 12,
      barLength: 84,
      barTopThickness: 1.5,
      raisedBarHeight: 6,

      // Calculated
      get kneeSpace() { return this.barDepth - this.cabinetDepth },
      get barFromLR() { return this.barTopHeight + this.stepHeight },
      get cabinetHeight() { return this.barFromLR - 4 },
    };

    // ============================================
    // SCENE SETUP
    // ============================================
    const canvas = document.getElementById('canvas');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a2e);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 500);
    camera.position.set(-60, 48, 80);

    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    // OrbitControls
    const controls = new OrbitControls(camera, canvas);
    controls.target.set(42, 30, 0);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 30;
    controls.maxDistance = 200;
    controls.maxPolarAngle = Math.PI / 2;
    controls.update();

    // ============================================
    // LIGHTING
    // ============================================
    // Ambient light - base illumination
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);

    // Key light - main shadow-casting light
    const keyLight = new THREE.DirectionalLight(0xffffff, 1.0);
    keyLight.position.set(50, 80, 30);
    keyLight.castShadow = true;
    keyLight.shadow.mapSize.width = 2048;
    keyLight.shadow.mapSize.height = 2048;
    keyLight.shadow.camera.near = 10;
    keyLight.shadow.camera.far = 200;
    keyLight.shadow.camera.left = -100;
    keyLight.shadow.camera.right = 100;
    keyLight.shadow.camera.top = 100;
    keyLight.shadow.camera.bottom = -100;
    scene.add(keyLight);

    // Fill light - reduce harsh shadows
    const fillLight = new THREE.DirectionalLight(0x8080a0, 0.4);
    fillLight.position.set(-30, 40, -20);
    scene.add(fillLight);

    // Axes helper for development
    const axesHelper = new THREE.AxesHelper(50);
    scene.add(axesHelper);

    // Grid helper for development
    const gridHelper = new THREE.GridHelper(200, 20, 0x3b82f6, 0x1e3a5f);
    scene.add(gridHelper);

    // ============================================
    // MATERIALS
    // ============================================
    const materials = {
      livingRoomFloor: new THREE.MeshStandardMaterial({
        color: 0x8b7355,  // warm oak
        roughness: 0.8,
        metalness: 0.0
      }),
      kitchenFloor: new THREE.MeshStandardMaterial({
        color: 0xd4c4a8,  // cream tile
        roughness: 0.6,
        metalness: 0.0
      }),
      stepFace: new THREE.MeshStandardMaterial({
        color: 0xf5f5f5,  // white trim
        roughness: 0.5
      }),
      wall: new THREE.MeshStandardMaterial({
        color: 0xd4c4a8,  // beige
        roughness: 0.9,
        side: THREE.DoubleSide
      }),
      column: new THREE.MeshStandardMaterial({
        color: 0xffffff,  // white
        roughness: 0.5
      }),
      cabinet: new THREE.MeshStandardMaterial({
        color: 0x2d4a6a,  // dark blue-gray
        roughness: 0.7,
        metalness: 0.1
      }),
      butcherBlock: new THREE.MeshStandardMaterial({
        color: 0x92400e,  // warm brown
        roughness: 0.4,
        metalness: 0.0
      }),
    };

    // ============================================
    // ROOM GEOMETRY
    // ============================================
    function createRoom() {
      const room = new THREE.Group();
      room.name = 'room';

      // Living room floor (origin level, Y=0)
      const lrFloorGeo = new THREE.BoxGeometry(120, 2, 80);
      const lrFloor = new THREE.Mesh(lrFloorGeo, materials.livingRoomFloor);
      lrFloor.position.set(60, -1, 40);
      lrFloor.receiveShadow = true;
      room.add(lrFloor);

      // Kitchen floor (elevated by stepHeight)
      const kitchenFloorGeo = new THREE.BoxGeometry(120, 2, 60);
      const kitchenFloor = new THREE.Mesh(kitchenFloorGeo, materials.kitchenFloor);
      kitchenFloor.position.set(60, CONFIG.stepHeight - 1, -30);
      kitchenFloor.receiveShadow = true;
      room.add(kitchenFloor);

      // Step face (vertical face between floors)
      const stepFaceGeo = new THREE.BoxGeometry(CONFIG.barLength, CONFIG.stepHeight, 2);
      const stepFace = new THREE.Mesh(stepFaceGeo, materials.stepFace);
      stepFace.position.set(CONFIG.barLength / 2, CONFIG.stepHeight / 2, 0);
      room.add(stepFace);

      // Back wall
      const backWallGeo = new THREE.PlaneGeometry(200, 96);
      const backWall = new THREE.Mesh(backWallGeo, materials.wall);
      backWall.position.set(100, 48, -60);
      backWall.receiveShadow = true;
      room.add(backWall);

      // Left wall (partial)
      const leftWallGeo = new THREE.PlaneGeometry(120, 96);
      const leftWall = new THREE.Mesh(leftWallGeo, materials.wall);
      leftWall.position.set(0, 48, 0);
      leftWall.rotation.y = Math.PI / 2;
      room.add(leftWall);

      // White column at bar end
      const columnGeo = new THREE.BoxGeometry(6, 96, 6);
      const column = new THREE.Mesh(columnGeo, materials.column);
      column.position.set(CONFIG.barLength + 3, 48, 0);
      column.castShadow = true;
      room.add(column);

      return room;
    }

    // Add room to scene
    const room = createRoom();
    scene.add(room);

    // ============================================
    // BAR GEOMETRY
    // ============================================
    function createBar(isTiered = false) {
      const bar = new THREE.Group();
      bar.name = isTiered ? 'bar-tiered' : 'bar-flush';

      const cabinetWidth = CONFIG.cabinetDepth;
      const cabinetHeight = CONFIG.cabinetHeight;
      const cabinetLength = CONFIG.barLength;

      // Cabinet box - extends from LR floor to underside of bar top
      const cabinetGeo = new THREE.BoxGeometry(cabinetLength, cabinetHeight, cabinetWidth);
      const cabinet = new THREE.Mesh(cabinetGeo, materials.cabinet);
      // Position: centered on X, bottom at Y=0 (LR floor), front edge at Z=0 (step line)
      cabinet.position.set(
        cabinetLength / 2,
        cabinetHeight / 2,
        -cabinetWidth / 2
      );
      cabinet.castShadow = true;
      cabinet.receiveShadow = true;
      bar.add(cabinet);

      // Butcher block top
      const barTopWidth = CONFIG.barDepth;
      const barTopThick = CONFIG.barTopThickness;
      const barTopY = CONFIG.stepHeight + CONFIG.barTopHeight;

      if (isTiered) {
        // Counter level (kitchen side) - over the overhang area
        const counterGeo = new THREE.BoxGeometry(cabinetLength, barTopThick, CONFIG.kneeSpace);
        const counter = new THREE.Mesh(counterGeo, materials.butcherBlock);
        counter.position.set(
          cabinetLength / 2,
          barTopY - barTopThick / 2,
          -CONFIG.cabinetDepth - CONFIG.kneeSpace / 2
        );
        counter.castShadow = true;
        counter.receiveShadow = true;
        bar.add(counter);

        // Raised bar section (living room side)
        const raisedY = barTopY + CONFIG.raisedBarHeight;
        const raisedGeo = new THREE.BoxGeometry(cabinetLength, barTopThick, CONFIG.cabinetDepth);
        const raised = new THREE.Mesh(raisedGeo, materials.butcherBlock);
        raised.position.set(
          cabinetLength / 2,
          raisedY - barTopThick / 2,
          -CONFIG.cabinetDepth / 2
        );
        raised.castShadow = true;
        raised.receiveShadow = true;
        bar.add(raised);

        // Vertical transition piece between levels
        const vertGeo = new THREE.BoxGeometry(cabinetLength, CONFIG.raisedBarHeight, barTopThick);
        const vert = new THREE.Mesh(vertGeo, materials.butcherBlock);
        vert.position.set(
          cabinetLength / 2,
          barTopY + CONFIG.raisedBarHeight / 2 - barTopThick / 2,
          -CONFIG.cabinetDepth
        );
        vert.castShadow = true;
        bar.add(vert);

      } else {
        // Flush - single continuous bar top
        const barTopGeo = new THREE.BoxGeometry(cabinetLength, barTopThick, barTopWidth);
        const barTop = new THREE.Mesh(barTopGeo, materials.butcherBlock);
        barTop.position.set(
          cabinetLength / 2,
          barTopY - barTopThick / 2,
          -barTopWidth / 2
        );
        barTop.castShadow = true;
        barTop.receiveShadow = true;
        bar.add(barTop);
      }

      return bar;
    }

    // Create both versions, show flush by default
    const barFlush = createBar(false);
    const barTiered = createBar(true);
    barTiered.visible = false;

    scene.add(barFlush);
    scene.add(barTiered);

    // State
    let currentPreset = 'flush';

    // Update camera target to center on bar
    controls.target.set(CONFIG.barLength / 2, 30, 0);
    controls.update();

    // ============================================
    // ANIMATION LOOP
    // ============================================
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // ============================================
    // RESIZE HANDLER
    // ============================================
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    console.log('Kitchen Bar 3D - Config:', CONFIG);
  </script>
</body>
</html>
